<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Order Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* 기본 스타일링 */
        body {
            /* body 스타일 일부 수정 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            padding-top: 20px; /* navbar 높이만큼 여백 */
        }
        .container { display: flex; gap: 30px; width: 100%; max-width: 1000px; margin:0 auto }
        .card { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); padding: 20px; }
        .product-list { flex: 2; }
        .product-list h2, .summary h2 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 16px; font-weight: 600; }
        .product-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid #f0f2f5; }
        .product-item:last-child { border-bottom: none; }
        .product-info { display: flex; align-items: center; gap: 15px; }
        .product-info img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .product-details p { margin: 0; }
        .product-details .name { font-weight: 500; }
        .product-details .desc { font-size: 0.9em; color: #666; }
        .price { font-weight: 500; min-width: 70px; text-align: right; }
        .add-btn { background-color: #007bff; color: white; border: none; border-radius: 5px; padding: 8px 16px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        .add-btn:hover { background-color: #0056b3; }
        .summary { flex: 1; position: sticky; top: 40px; }
        .summary-item-list { list-style: none; padding: 0; margin: 0; min-height: 200px; min-width: 120px }
        .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; font-size: 0.95em; }
        .quantity-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0;}
        .quantity-btn { background-color: #e9ecef; border: none; border-radius: 50%; width: 24px; height: 24px; font-weight: bold; cursor: pointer; line-height: 24px; text-align: center; }
        .quantity { font-weight: 500; }
        .form-group { margin-top: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; font-weight: 500; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .total-section { margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 1.2em; font-weight: bold; }
        .checkout-btn { margin-top: 24px; width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .checkout-btn:hover { background-color: #218838; }
    </style>
</head>
<body th:data-initial-cart-items="${initialCartItemsJson}">

<div th:replace="~{fragments/navbar :: navbarFragment}"></div>

<div class="container">
    <section class="card product-list">
        <h2>상품 목록</h2>
        <div id="product-items-container">
            <div th:each="product : ${products}" class="product-item"
                 th:data-id="${product.productId}"
                 th:data-name="${product.name}"
                 th:data-price="${product.price}"
                 th:data-stock="${product.quantity}"> <div class="product-info">
                <img th:src="@{/images/{imageName}(imageName=${product.photoUrl})}" alt="커피콩">
                <div class="product-details">
                    <p class="name" th:text="${product.name}">상품 이름</p>
                    <p class="desc"> 향긋한 원두 커피</p>
                </div>
            </div>
                <span class="price" th:text="${#numbers.formatInteger(product.price, 3, 'COMMA')} + '원'">5000원</span>
                <button class="add-btn">추가</button>
            </div>
        </div>
    </section>

    <aside class="card summary">
        <form id="order-form" class="card summary" th:action="@{/orders/payment}" method="post">
            <h2>주문내역</h2>
            <ul id="summary-item-list" class="summary-item-list"></ul>
            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" name="email" placeholder="devCourse@gmail.com">
            </div>
            <div class="form-group">
                <label for="customerName">주문자명</label>
                <input type="text" id="customerName" name="customerName">
            </div>
            <div class="form-group">
                <label for="address">주소</label>
                <input type="text" id="address" name="address">
            </div>
            <div class="form-group">
                <label for="zipcode">우편번호</label>
                <input type="text" id="zipcode" name="zipcode">
            </div>
            <div class="notice">
                <span id="notice">당일 오후 2시 이후의 주문 건은 다음 날 배송이 시작됩니다.</span>
            </div>
            <div class="total-section">
                <span>총금액</span>
                <span id="total-price">0원</span>
            </div>
            <button type="submit" class="checkout-btn">결제하기</button>
        </form>
    </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. 전역 변수 및 요소 선언 ---
        const productItemsContainer = document.getElementById('product-items-container');
        const summaryItemList = document.getElementById('summary-item-list');
        const totalPriceElement = document.getElementById('total-price');
        const orderForm = document.getElementById('order-form');
        let cart = {}; // 장바구니 데이터를 관리하는 클라이언트 사이드 객체

        // --- 2. 이벤트 리스너 등록 ---
        // 상품 목록 '추가' 버튼 클릭
        productItemsContainer.addEventListener('click', (event) => {
            if (event.target.classList.contains('add-btn')) {
                const productItem = event.target.closest('.product-item');
                const id = productItem.dataset.id;
                const name = productItem.dataset.name;
                const price = parseInt(productItem.dataset.price, 10);
                const stock = parseInt(productItem.dataset.stock, 10);
                addToCart(id, name, price, stock);
            }
        });

        // 주문 내역 수량 변경(+,-) 버튼 클릭
        summaryItemList.addEventListener('click', (event) => {
            if (event.target.classList.contains('quantity-btn')) {
                const summaryItem = event.target.closest('.summary-item');
                const id = summaryItem.dataset.id;
                const change = parseInt(event.target.dataset.change, 10);
                updateQuantity(id, change);
            }
        });

        // '결제하기' 폼 제출
        orderForm.addEventListener('submit', (event) => {
            event.preventDefault();

            if (!prepareFormData()) {
                return;
            }
            // 폼 유효성 검사를 그 다음에 실행
            if (!validateForm()) {
                return;
            }
            orderForm.submit();
        });

        // --- 3. 핵심 함수 정의 ---

        /**
         * 페이지 로드 시, 서버에서 받은 데이터로 cart 객체를 복원하는 함수
         */
        function initializeCart() {
            const initialCartItemsJson = document.body.dataset.initialCartItems;
            const initialCartItems = JSON.parse(initialCartItemsJson);

            if (initialCartItems && initialCartItems.length > 0) {
                const productsData = {};
                document.querySelectorAll('.product-item').forEach(item => {
                    productsData[item.dataset.id] = {
                        name: item.dataset.name,
                        price: parseInt(item.dataset.price, 10),
                        stock: parseInt(item.dataset.stock, 10)
                    };
                });

                initialCartItems.forEach(item => {
                    const product = productsData[item.productId];
                    if (product) {
                        cart[item.productId] = {
                            name: product.name,
                            price: product.price,
                            quantity: item.quantity,
                            stock: product.stock
                        };
                    }
                });
                renderCart();
            }
        }

        function addToCart(id, name, price, stock) {
            if (cart[id] && cart[id].quantity >= stock) {
                alert('재고가 부족하여 더 이상 추가할 수 없습니다.');
                return;
            }
            if (cart[id]) {
                cart[id].quantity++;
            } else {
                cart[id] = { name, price, quantity: 1, stock: stock };
            }
            renderCart();
        }

        function updateQuantity(id, change) {
            if (!cart[id]) return;
            if (change > 0 && cart[id].quantity >= cart[id].stock) {
                alert('재고가 부족하여 더 이상 추가할 수 없습니다.');
                return;
            }
            cart[id].quantity += change;
            if (cart[id].quantity <= 0) {
                delete cart[id];
            }
            renderCart();
        }

        function calculateTotalPrice() {
            let total = 0;
            for (const id in cart) {
                total += cart[id].price * cart[id].quantity;
            }
            return total;
        }

        function renderCart() {
            summaryItemList.innerHTML = '';
            const totalPrice = calculateTotalPrice();
            for (const id in cart) {
                const item = cart[id];
                const li = document.createElement('li');
                li.className = 'summary-item';
                li.dataset.id = id;
                li.innerHTML = `
                    <span>${item.name}</span>
                    <div class="quantity-controls">
                        <button class="quantity-btn" data-change="-1">-</button>
                        <span class="quantity">${item.quantity}개</span>
                        <button type="button" class="quantity-btn" data-change="1">+</button>
                    </div>
                `;
                summaryItemList.appendChild(li);
            }
            totalPriceElement.textContent = `${totalPrice.toLocaleString()}원`;
        }

        /**
         * 폼 제출 전 유효성 검사를 수행하는 함수
         * @returns {boolean} - 유효하면 true, 아니면 false
         */
        function validateForm() {
            const emailInput = document.getElementById('email');
            const customerNameInput = document.getElementById('customerName');
            const addressInput = document.getElementById('address');

            if (emailInput.value.trim() === '') {
                alert('이메일을 입력해주세요.');
                emailInput.focus();
                return false;
            }
            else if (customerNameInput.value.trim() === '') {
                alert('주문자명을 입력해주세요.');
                customerNameInput.focus();
                return false;
            }
            if (addressInput.value.trim() === '') {
                alert('주소지를 입력해주세요.');
                addressInput.focus();
                return false;
            }
            return true;
        }

        /**
         * 폼 제출을 위해 cart 객체를 hidden input으로 변환하는 함수
         * @returns {boolean} - 장바구니에 상품이 있으면 true, 아니면 false
         */
        function prepareFormData() {
            if (Object.keys(cart).length === 0) {
                alert('주문할 상품을 추가해주세요.');
                return false;
            }

            orderForm.querySelectorAll('input[type="hidden"]').forEach(input => input.remove());

            let index = 0;
            for (const id in cart) {
                const item = cart[id];
                const productIdInput = document.createElement('input');
                productIdInput.type = 'hidden';
                productIdInput.name = `orderItems[${index}].productId`;
                productIdInput.value = id;
                orderForm.appendChild(productIdInput);

                const quantityInput = document.createElement('input');
                quantityInput.type = 'hidden';
                quantityInput.name = `orderItems[${index}].quantity`;
                quantityInput.value = item.quantity;
                orderForm.appendChild(quantityInput);
                index++;
            }
            const totalPriceInput = document.createElement('input');
            totalPriceInput.type = 'hidden';
            totalPriceInput.name = 'totalPrice';
            totalPriceInput.value = calculateTotalPrice();
            orderForm.appendChild(totalPriceInput);

            return true;
        }

        // --- 4. 페이지 초기화 실행 ---
        initializeCart();
    });
</script>
</body>
</html>
</body>
</html>